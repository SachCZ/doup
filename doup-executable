#!/usr/bin/python3

import sys
import os

def main(tag):
    dockerfile = "Dockerfile.{}".format(tag)
    print("Building and running: {}".format(tag))
    command = "docker run --rm -it $(DOCKER_BUILDKIT=1 docker build -t {} -f {} --ssh github={}/.ssh/id_rsa -q .)".format(
            tag, os.path.join(os.environ["DOUP_SEARCHDIR"], dockerfile), os.environ["HOME"]
    )
    print(command)
    os.system(command)
    os.system("docker rmi {}".format(tag))
    print("Success.")


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Error: Requires exactly one argument!")
        sys.exit(1)
    main(sys.argv[1])


