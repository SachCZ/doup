#!/usr/bin/python3

import sys
import os

def main(tag):
    base_dir = os.path.join(os.environ["DOUP_SEARCHDIR"], tag)
    if not os.path.isdir(base_dir)):
        raise RuntimeError("{} is not a dir!".format(base_dir))

    print("Building and running: {}".format(tag))
    build_command = "DOCKER_BUILDKIT=1 docker build -t {} -f {} --ssh github={} .".format(
        tag,
        os.path.join(base_dir, , "Dockerfile"),
        os.path.join(os.environ["HOME"], ".ssh/id_rsa")
    )
    print(build_command)
    os.system(build_command)
    local_dir_path = os.path.join(base_dir, "home")
    if not os.path.isdir(local_dir_path):
        raise RuntimeError("{} is not a dir!".format(local_dir_path))
    volume_mount = "-v {}:{}".format(local_dir_path, "/home/devuser")
    print("Mounting {} to /home/devuser.".format(local_dir_path))
    run_command = "docker run -v {}:/home/devuser/.ssh {} --rm -it {}".format(
        os.path.join(os.environ["HOME"], ".ssh"),
        volume_mount,
        tag
    )
    print(run_command)
    os.system(run_command)
    os.system("docker rmi {}".format(tag))
    print("Success.")


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Error: Requires exactly one argument!")
        sys.exit(1)
    main(sys.argv[1])


